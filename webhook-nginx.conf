# nginx configuration snippet for GitHub webhook endpoint
# Add this to your existing sethstenzel.me nginx configuration
#
# Instructions:
# 1. This should be added inside the "server" block that handles HTTPS (port 443)
# 2. Add it BEFORE the main "location / {" block
#
# Example placement:
#   server {
#       listen 443 ssl http2;
#       server_name sethstenzel.me www.sethstenzel.me;
#
#       # SSL configuration...
#
#       # ADD WEBHOOK CONFIG HERE:
#       location /webhook {
#           ...
#       }
#
#       # Then your main app location
#       location / {
#           proxy_pass http://127.0.0.1:18001;
#           ...
#       }
#   }

# GitHub Webhook endpoint
location /webhook {
    # Only allow POST requests
    if ($request_method != POST) {
        return 405;
    }

    # Proxy to webhook listener service
    proxy_pass http://127.0.0.1:18100;
    proxy_http_version 1.1;

    # Standard proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # GitHub webhook headers
    proxy_set_header X-GitHub-Event $http_x_github_event;
    proxy_set_header X-Hub-Signature $http_x_hub_signature;
    proxy_set_header X-Hub-Signature-256 $http_x_hub_signature_256;

    # Timeouts (deployments can take a while)
    proxy_connect_timeout 10s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;

    # Buffer settings
    proxy_buffering off;

    # Security: limit request size (GitHub webhooks are small)
    client_max_body_size 10M;
}

# Optional: Health check endpoint (useful for monitoring)
location /webhook/health {
    proxy_pass http://127.0.0.1:18100/health;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
}
